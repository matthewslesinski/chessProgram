package stringTranslators;

import java.util.Arrays;
import java.util.List;
import java.util.function.BiConsumer;
import java.util.stream.Collectors;

import boardFeatures.Square;
import lines.File;
import lines.Rank;
import representation.Board;
import representation.CastlingRights;
import support.Constants;
import support.UtilityFunctions;

public class FENStringWriter {

	private static final List<BiConsumer<Board, StringBuilder>> actions = 
			Arrays.asList(FENStringWriter::addPosition, FENStringWriter::addColorToMove, FENStringWriter::addCastlingRights,
					FENStringWriter::addEnPassantRights, FENStringWriter::addPliesSinceChange, FENStringWriter::addMoveNumber);
	
	public static String makeFEN(Board board) {
		StringBuilder builder = new StringBuilder();
		List<Runnable> appliedActions = (List<Runnable>) actions.stream().map(action -> UtilityFunctions.bind(action, board, builder)).collect(Collectors.toList());
		UtilityFunctions.joinActions(appliedActions, () -> builder.append(Constants.SINGLE_SPACE));
		return builder.toString();
	}
	
	private static void addPosition(Board board, StringBuilder builder) {
		List<Runnable> actions = Arrays.stream(Rank.values()).map(rank -> (Runnable) () -> addFENForRank(board, rank, builder)).collect(Collectors.toList());
		UtilityFunctions.joinActions(UtilityFunctions.reverseList(actions), () -> builder.append(Constants.SLASH));
	}
	
	private static void addFENForRank(Board board, Rank rank, StringBuilder builder) {
		
	}
	
	private static void addColorToMove(Board board, StringBuilder builder) {
		builder.append(board.whoseMove().toString().charAt(0));
	}
	
	private static void addCastlingRights(Board board, StringBuilder builder) {
		boolean addedCastleRight = false;
		for (CastlingRights right : CastlingRights.values()) {
			addedCastleRight |= addCastlingRight(board, builder, right);
		}
		if (!addedCastleRight) {
			builder.append(Constants.DASH);
		}
	}
	
	private static boolean addCastlingRight(Board board, StringBuilder builder, CastlingRights right) {
		boolean canCastle = board.canCastle(right);
		if (canCastle) {
			builder.append(right.toString());
		}
		return canCastle;
	}
	
	private static void addEnPassantRights(Board board, StringBuilder builder) {
		File enPassantFile = board.enPassantCaptureFile();
		if (enPassantFile != null) {
			builder.append(Square.getByFileAndRank(enPassantFile, board.whoseMove().getEnPassantCaptureRank()));
		}
		builder.append(Constants.DASH);
	}
	
	private static void addPliesSinceChange(Board board, StringBuilder builder) {
		
	}
	
	private static void addMoveNumber(Board board, StringBuilder builder) {
		
	}
}
